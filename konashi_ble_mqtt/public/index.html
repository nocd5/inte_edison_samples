<meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
<script type="text/javascript" src="http://www.google.com/jsapi"></script>

<input type="button" value="connect" onClick="connect()" />
<input type="button" value="disconnect" onClick="disconnect()" />
<div id="chart1">Now Loading ...</div>

<script type="text/javascript">

var host = 'ws://intel-edison-mqtt.herokuapp.com';
var ws = null;
var chart = null;
var autoReconnect = true;
var currentData = null
var chart1Options = {
  title: 'Koshian/Uzuki',
  width: window.innerWidth - 10,
  height: window.innerHeight - 60,
  pointSize: 5,
  chartArea: {'width':'80%', 'height':'65%', 'left':60 },
  hAxis: {
      title:'Time',
      titleTextStyle:{italic:false},
      slantedText:true,
      gridlines: {
        units: {
          years: {format: ["YYYY"]},
          months: {format: ["YYYY/MM"]},
          days: {format: ["YYYY/MM/DD"]},
          hours: {format: ["YYYY/MM/DD HH"]},
          minutes: {format: ["HH:mm"]},
          seconds: {format: ["HH:mm:ss"]},
          milliseconds: {format: ['HH:mm:ss.SSS']},
        }
      },
  },
  vAxis: {
    title:'Values',
    titleTextStyle:{italic:false},
    slantedText:true,
    maxValue: 100,
    minValue: 0,
  },
  explorer: { actions: ['dragToZoom', 'rightClickToReset'], maxZoomIn:0.01 },
};

window.addEventListener('resize', function(){
  chart1Options["width"] = window.innerWidth - 10;
  chart1Options["height"] = window.innerHeight - 60;
  drawChart();
});

google.load('visualization', '1.0', {'packages':['corechart'], 'language': 'en'});
google.setOnLoadCallback(function(){
  connect();
});

function initialize(){
  this.ws = new(window.WebSocket || window.MozWebSocket)(this.host, "websocket");
  this.ws.addEventListener('open', function(event){
    console.log("connected");
  });
  this.ws.addEventListener('close', function(event){
    console.log("disconnected");
    if (autoReconnect === true){
      this.initialize();
    }
  });
  this.chart = new google.visualization.LineChart(document.getElementById('chart1'));
  this.ws.addEventListener('message', function(message){
    drawChart(JSON.parse(message.data).map( function(e){
      if (e[0] == 0){
        e[0] = null;
      }
      else {
        var dateArray = e[0].split(':').map(function(e){return Number(e)})
        e[0] = new Date(dateArray[0], dateArray[1]-1, dateArray[2], dateArray[3], dateArray[4], dateArray[5]);
      }
      return e;
    }));
  });
}

function drawChart(values){
  if (values == null){
    if (this.currentData != null){
      this.chart.draw(this.currentData, this.chart1Options);
    }
    return;
  }

  var dataTable = new google.visualization.DataTable();
  dataTable.addColumn('datetime', 'Time');
  dataTable.addColumn('number', 'Temperature[degC]');
  dataTable.addColumn('number', 'Humidity[%RH]');
  dataTable.addRows(values);
  var formatter = new google.visualization.DateFormat({pattern: 'yyyy/MM/dd HH:mm:ss'});
  formatter.format(dataTable, 0);
  this.chart.draw(dataTable, this.chart1Options);

  this.currentData = dataTable;
}

function disconnect(){
  this.autoReconnect = false;
  this.ws.close();
  this.ws = null;
}

function connect(){
  this.initialize();
  var autoReconnect = true;
}

</script>

